# Copyright 2025 The MoneyPod Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

version: "3"

set: [pipefail]

includes:
  tools:
    taskfile: taskfile.tools.yaml
    internal: true

tasks:
  create:
    desc: Create a KIND cluster
    deps: [tools:all]
    cmds:
      - silent: true
        cmd: |-
          mkdir -p "$(dirname {{ .kind.configPath }})"
          echo {{ b64enc .kind.config }} | base64 -d >{{ .kind.configPath }}
      - >-
        KUBECONFIG={{ squote .kubeconfig }} {{ .bin.kind }} create cluster
        --name {{ .kind.name }} --config {{ .kind.configPath }}
      - chmod 0600 {{ squote .kubeconfig }}
      - task: kubeconfig
    status:
      - "{{ .bin.kind }} get clusters | grep -qF {{ .kind.name }}"

  bootstrap:
    desc: Install flux, cert-manager, prometheus-crds and bootstrap job
    deps: [create]
    cmds:
      - "{{ .bin.kubectl }} apply --wait -f https://github.com/fluxcd/flux2/releases/latest/download/install.yaml"
      - "{{ .bin.kubectl }} wait -n flux-system --for=condition=Available deployments --all --timeout=5m"
      - "{{ .bin.kubectl }} apply --wait -k flux/bootstrap"
      - "{{ .bin.kubectl }} wait -n cert-manager --for=condition=Available deployments --all --timeout=5m"
      - "{{ .bin.kubectl }} wait -n default --for=condition=Complete jobs --all --timeout=5m"
      - "{{ .bin.kubectl }} wait -n kube-system --for=condition=Available deployments --all --timeout=5m"

  victoria-metrics:
    desc: Same as bootstrap + install victoria-metrics and grafana
    cmds:
      - "{{ .bin.kubectl }} apply --wait -k flux/victoria-metrics"
      - >-
        {{ .bin.kubectl }} -n moneypod get configmap moneypod-dashboards -o jsonpath={.data} |
        xargs -0 printf "%s\ndata: %s" "$({{ .bin.kubectl }} create configmap -n victoria-metrics -o yaml --dry-run=client moneypod-dashboards)" |
        {{ .bin.kubectl }} apply -f -
      - "{{ .bin.kubectl }} wait -n victoria-metrics --for=condition=Ready helmreleases --all --timeout=5m"
      - "{{ .bin.kubectl }} wait -n victoria-metrics --for=condition=Available deployments --all --timeout=5m"
      - "{{ .bin.kubectl }} wait -n victoria-metrics --for='jsonpath={.status.updateStatus}=operational' vmsingles,vmalerts,vmagents --all --timeout=10m"
      - "{{ .bin.kubectl }} -n victoria-metrics rollout restart deployment victoria-metrics-grafana"
      - |
        if ! {{ .bin.kubectl }} -n moneypod get vmrules moneypod-rules 1>/dev/null; then
          {{ .bin.kubectl }} -n victoria-metrics rollout restart deployment victoria-metrics-victoria-metrics-operator
        fi
      - "{{ .bin.kubectl }} wait -n victoria-metrics --for=condition=Ready pods --all --timeout=5m"
      - "echo 'info: default Grafana credentials are admin:admin'"
    preconditions:
      - sh: "{{ .bin.kubectl }} -n moneypod get configmap moneypod-dashboards -o name 1>/dev/null"
        msg: Install operator first with `task install-operator`

  prometheus:
    desc: Same as bootstrap + install prometheus and grafana
    cmds:
      - "{{ .bin.kubectl }} apply --wait -k flux/prometheus"
      - >-
        {{ .bin.kubectl }} -n moneypod get configmap moneypod-dashboards -o jsonpath={.data} |
        xargs -0 printf "%s\ndata: %s" "$({{ .bin.kubectl }} create configmap -n prometheus -o yaml --dry-run=client moneypod-dashboards)" |
        {{ .bin.kubectl }} apply -f -
      - "{{ .bin.kubectl }} wait -n prometheus --for=condition=Ready helmreleases --all --timeout=5m"
      - "{{ .bin.kubectl }} wait -n prometheus --for=condition=Available deployments --all --timeout=5m"
      - "{{ .bin.kubectl }} wait -n prometheus --for=condition=Available prometheuses --all --timeout=10m"
      - "{{ .bin.kubectl }} -n prometheus rollout restart deployment prometheus-grafana"
      - "{{ .bin.kubectl }} wait -n prometheus --for=condition=Ready pods --all --timeout=5m"
      - "echo 'info: default Grafana credentials are admin:admin'"
    preconditions:
      - sh: "{{ .bin.kubectl }} -n moneypod get configmap moneypod-dashboards -o name 1>/dev/null"
        msg: Install operator first with `task install-operator`

  kubeconfig:
    desc: Export kubeconfig to {{ .kubeconfig }}
    deps: [create]
    cmds:
      - "{{ .bin.kind }} export kubeconfig --name {{ .kind.name }} --kubeconfig {{ squote .kubeconfig }}"
      - "{{ .bin.kubectl }} config set-context --current --namespace=moneypod"

  load:
    desc: Load image into cluster
    deps: [create]
    cmds:
      - "{{ .bin.kind }} load docker-image {{ .image }} --name {{ .kind.name }}"

  clean:
    desc: Delete the KIND cluster
    cmds:
      - cmd: "{{ .bin.kind }} delete cluster --name {{ .kind.name }} 2>/dev/null"
        ignore_error: true
      - rm -f {{ .kubeconfig }}
    status:
      - |-
        if [ -f {{ .bin.kind }} ]; then
          {{ .bin.kind }} get clusters | grep -qF {{ .kind.name }}
        fi
      - test ! -f {{ .kubeconfig }}
