version: "3"

set: [pipefail]

tasks:
  create:
    desc: Create a KIND cluster
    vars:
      kindConfigPath: '{{ print .TASK_TEMP_DIR "/kind-config.yaml" | squote }}'
    cmds:
      - cmd: echo {{ b64enc .kind.config }} | base64 -d >{{ .kindConfigPath }}
        silent: true
      - |-
        if ! kind get clusters | grep -qF {{ .kind.name }}; then
          KUBECONFIG={{ squote .kubeconfig }} kind create cluster --name {{ .kind.name }} --config {{ .kindConfigPath }}
        fi
      - chmod 0600 {{ squote .kubeconfig }}

  kubeconfig:
    desc: Export kubeconfig to {{ .kubeconfig }}
    cmds:
      - kind export kubeconfig --name {{ .kind.name }} --kubeconfig {{ squote .kubeconfig }}

  load:
    desc: Load image into cluster
    cmds:
      - kind load docker-image {{ .image }} --name {{ .kind.name }}

  clean:
    desc: Delete the KIND cluster
    cmds:
      - kind delete cluster --name {{ .kind.name }}
      - rm -f {{ .kubeconfig }}
