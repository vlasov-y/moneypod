# Copyright 2025 The MoneyPod Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

version: "3"

set: [pipefail]

includes:
  generate:
    taskfile: taskfile.generate.yaml
    internal: true
  tools:
    taskfile: taskfile.tools.yaml
    internal: true

tasks:
  unit:
    desc: Run unit tests
    deps: [tools:all, generate:all]
    cmds:
      - silent: true
        cmd: >-
          KUBEBUILDER_ASSETS=$({{ squote .bin.setupEnvtest }} use --bin-dir {{ squote .localBin }} -p path {{ squote .envtestVersion }})
          go test $(go list ./... | grep -v /e2e) -coverprofile cover.out -v -ginkgo.v

  e2e:
    desc: Run end-to-end tests
    cmds:
      - go test ./test/e2e/ -v -ginkgo.v

  clean:
    desc: Remove cover.out
    cmds:
      - rm -rvf cover.out
    status:
      - test ! -f cover.out
