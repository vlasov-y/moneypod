# Copyright 2025 The MoneyPod Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

version: "3"

set: [pipefail]

includes:
  tools:
    taskfile: taskfile.tools.yaml
    internal: true

tasks:
  all:
    desc: Aggregator for manifests, code, fmt and vet
    deps: [fmt, vet]
    cmds:
      - task: manifests
      - task: code

  manifests:
    desc: Generate WebhookConfiguration, ClusterRole and CustomResourceDefinitions
    deps: [tools:controller-gen]
    cmds:
      - '{{ .bin.controllerGen }} rbac:roleName=app crd webhook paths="./..." output:crd:artifacts:config={{ .manifestPath.crds }} output:rbac:dir={{ .manifestPath.rbac }}'

  code:
    desc: Generate code containing DeepCopy, DeepCopyInto, and DeepCopyObject methods
    deps: [tools:controller-gen]
    cmds:
      - '{{ .bin.controllerGen }} object:headerFile="hack/boilerplate.go.txt" paths="./..."'

  fmt:
    desc: Run go fmt against the code
    cmds:
      - go fmt ./...

  vet:
    desc: Run go vet against the code
    cmds:
      - go vet ./...

  distribute:
    desc: Created install.yaml with all manifests compiled
    deps: [tools:kustomize]
    cmds:
      - mkdir -p {{ squote .distPath }}
      - |-
        cd {{ squote .manifestPath.distribute }}
        {{ .bin.kustomize }} edit set image {{ print "controller=" .image | squote }}
      - '{{ .bin.kustomize }} build {{ squote .manifestPath.distribute }} >{{ print .distPath "/install.yaml" | squote }}'
      - 'cp -vf {{ print .manifestPath.distribute "/prometheus/dashboard.json" | squote }} {{ print .distPath "/dashboard.json" | squote }}'
      - 'cp -vf {{ print .manifestPath.distribute "/prometheus/iam-policy.json" | squote }} {{ print .distPath "/aws-iam-policy.json" | squote }}'
