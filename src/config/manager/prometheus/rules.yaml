apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: rules
spec:
  groups:
    - name: moneypod.io
      interval: 30s
      rules:
        - record: moneypod:pod_cpu_total_cost
          expr: |
            (pod_cpu_usage_seconds_total / 3600)
            * on(cluster, node, namespace, pod) group_left (owner_kind, owner_name)
            moneypod_pod_cpu_hourly_cost

        - record: moneypod:pod_memory_total_cost
          expr: |
            ((time() - kube_pod_created) / 3600)
            * on(cluster, namespace, pod)
            avg_over_time(
                sum by (cluster, namespace, pod) (
                  container_memory_working_set_bytes{image!="", container!=""}
                ) / 1024 / 1024 [5m]
              )
            * on(cluster, namespace, pod) group_left(owner_kind, owner_name, node)
            moneypod_pod_memory_hourly_cost

        - record: moneypod:pod_usage_total_cost
          expr: |
            moneypod:pod_cpu_total_cost
            + on(cluster, node, namespace, pod, owner_kind, owner_name)
            moneypod:pod_memory_total_cost

        - record: moneypod:pod_requests_total_cost
          expr: |
            ((time() - kube_pod_created) / 3600)
            * on(cluster, namespace, pod) group_left(owner_kind, owner_name, node)
            moneypod_pod_requests_hourly_cost

        - record: moneypod:pod_effective_total_cost
          expr: |
            max by (cluster, node, namespace, pod, owner_kind, owner_name) (
              moneypod:pod_usage_total_cost
              or
              moneypod:pod_requests_total_cost
            )

        - record: moneypod:node_total_cost
          expr: |
            ((time() - kube_node_created) / 3600)
            * on(cluster, node)
            moneypod_node_hourly_cost
