version: "3"

set: [pipefail]

tasks:
  all:
    desc: Installs CLI tools to {{ .localBin }}
    cmds:
      - mkdir -p {{ squote .localBin }} {{ squote .TASK_TEMP_DIR }}
      - task: controller-gen
      - task: kustomize
      - cmd: GOBIN={{ squote .localBin }} go install {{ squote .ITEM }}
        for:
          - github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest
          - sigs.k8s.io/controller-runtime/tools/setup-envtest@latest
          - sigs.k8s.io/kind@latest
      - >-
        {{ .bin.setupEnvtest }} use --bin-dir {{ squote .localBin }} -p path
        {{ squote .envtestVersion }} 1>{{ print .TASK_TEMP_DIR "/envtest-path" | squote }}
      - >-
        xargs realpath --relative-to={{ squote .localBin }} <{{ print .TASK_TEMP_DIR "/envtest-path" | squote }} |
        xargs printf "%s/kubectl" | xargs -I{} ln -fs {} {{ print .localBin "/kubectl" | squote }}
    status:
      - "{{ .bin.kind }} version"
      - "{{ .bin.kubectl }} version --client"
      - "{{ .bin.lint }} --version"
      - "{{ .bin.setupEnvtest }} version"

  controller-gen:
    desc: Installs controller-gen to {{ .bin.controllerGen }}
    cmds:
      - mkdir -p {{ squote .localBin }}
      - GOBIN={{ squote .localBin }} go install sigs.k8s.io/controller-tools/cmd/controller-gen@latest
    status:
      - "{{ .bin.controllerGen }} --version"

  kustomize:
    desc: Installs kustomize to {{ .bin.kustomize }}
    cmds:
      - mkdir -p {{ squote .localBin }}
      - GOBIN={{ squote .localBin }} go install sigs.k8s.io/kustomize/kustomize/v5@latest
    status:
      - "{{ .bin.kustomize }} version"

  clean:
    desc: Remove CLI tools from {{ .localBin }}
    cmds:
      - cmd: chmod 0755 -Rv {{ squote .localBin }}
        silent: true
      - rm -rvf {{ squote .localBin }}
    status:
      - test ! -d {{ squote .localBin }}
